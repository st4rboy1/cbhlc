#!/bin/bash

echo "ğŸš€ Running pre-push checks..."
echo ""

# Run the local test script
./scripts/test-local.sh

# Check if the local test script passed
if [ $? -ne 0 ]; then
    echo ""
    echo "âŒ Pre-push checks failed! Fix the issues before pushing."
    echo ""
    echo "Tip: You can bypass this check with 'git push --no-verify' (not recommended)"
    exit 1
fi

# Run tests with coverage but optimized for speed
echo ""
echo "ğŸ§ª Running tests with coverage check (optimized with SQLite)..."

# Use SQLite for much faster tests (5s vs 13s)
./vendor/bin/sail exec -T -e DB_CONNECTION=sqlite -e DB_DATABASE=:memory: laravel.test ./vendor/bin/pest --parallel --coverage --min=60 --coverage-text

# Check the exit status
if [ $? -ne 0 ]; then
    echo "âŒ Tests failed or coverage below 60%. Push aborted."
    exit 1
fi

echo "âœ… All tests passed with minimum 60% coverage!"
echo "âœ… Pre-push checks completed successfully!"
exit 0